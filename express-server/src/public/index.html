<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/sources/reset.css">
    <link rel="stylesheet" href="/sources/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;900&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <title> Web Socket </title>
</head>

<body>
    <div class="main-container">
        <div id="message-container"></div>
        <div class="form-container">
            <form id="form-message" method="POST">
                <label> Message
                    <input autofocus id="input-message" type="text" name="message">
                </label>
                <input id="submit-message" type="submit" value="Send">
            </form>
        </div>
    </div>

    <script src="/sources/socket.io.js"></script>
    <script type="application/javascript">
        const socket = io();
        const messages = document.getElementById('message-container');
        const form = document.getElementById('form-message');
        const input = document.getElementById('input-message');

        form.addEventListener('submit', e => {
          e.preventDefault();
          let message = input.value;

          if (message) {
            socket.emit('chat', { message, 'id': socket.id });
            input.value = '';
          }
        });

        socket.on('chat', data => {
          console.log(data);
          const message = document.createElement('div');
          message.setAttribute('class', 'message');

          const author = document.createElement('div');
          author.innerText = data.user.id + ' - ' + formatDate(data.timestamp);
          author.setAttribute('class', 'author');

          const content = document.createElement('div');
          content.innerText = data.message;
          content.setAttribute('class', 'content');

          message.appendChild(author);
          message.appendChild(content);

          messages.appendChild(message);
          messages.scrollTo(0, document.body.scrollHeight);
        });

        const formatDate = (timestamp) => {
          const date = new Date(timestamp);

          return formatDatePart(date.getDay()) + '/' + formatDatePart(date.getMonth()) + '/' + date.getFullYear() + ' '
            + formatDatePart(date.getHours()) + ':' + formatDatePart(date.getMinutes());
        }

        const formatDatePart = (part) => {
          return (part > 0 && part < 10) ? '0' + part : part;
        }
    </script>
</body>
</html>
