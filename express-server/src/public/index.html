<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/sources/reset.css">
    <link rel="stylesheet" href="/sources/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;900&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <title> Web Socket </title>
</head>

<body>
<div class="main-container">
    <div class="sidebar">
        <h1> Discuss </h1>
        <div id="rooms"></div>
    </div>
    <div class="page-content">
        <div id="room-title"> Symfony </div>
        <div id="message-container">
            <div class="message">
                <div class="author"> DrakxBot - 01/01/1970 00:00 </div>
                <div class="content"> Salut ! Je suis un message d'exemple. </div>
            </div>
        </div>
        <div class="form-container">
            <form id="form-message" method="POST">
                <label for="input-message"></label>
                <input autofocus id="input-message" type="text" name="message" placeholder="Type your message here ...">
                <input id="submit-message" type="submit" value="Send">
            </form>
        </div>
    </div>
</div>

<script src="/sources/socket.io.js"></script>

<!-- ROOMS HANDLING -->
<script type="application/javascript">
  const socket = io();
  const event = 'rooms';

  const rooms = document.getElementById('rooms');

  // rooms.innerHTML = '';

  socket.emit(event, {});

  socket.on('rooms', json => {
    const data = JSON.parse(json);
    const rooms = document.getElementById('rooms');

    // Clears all rooms
    rooms.innerHTML = '';

    data.forEach((room, index) => {
      console.log(room.urlImage);

      const roomElement = document.createElement('div');
      const pictureElement = document.createElement('img');

      roomElement.setAttribute('class', (index === 0) ? 'room current-room' : 'room');

      pictureElement.setAttribute('class', 'room-picture');
      pictureElement.setAttribute('title', room.title);
      pictureElement.setAttribute('alt', room.title);
      pictureElement.setAttribute('src', room.urlImage || 'profile.png');

      roomElement.appendChild(pictureElement);
      rooms.appendChild(roomElement);
    });
  });
</script>

<!-- FORM HANDLING -->
<script type="application/javascript">
  // The *socket* object is already defined in the previous script
  const messages = document.getElementById('message-container');
  const form = document.getElementById('form-message');
  const input = document.getElementById('input-message');

  form.addEventListener('submit', e => {
    e.preventDefault();
    let message = input.value;

    if (message) {
      socket.emit('chat', { message, 'id': socket.id });
      input.value = '';
    }
  });

  socket.on('chat', json => {
    const data = JSON.parse(json);

    const message = document.createElement('div');
    message.setAttribute('class', 'message');

    const author = document.createElement('div');
    author.innerText = data.pseudo || data.user.id + ' - ' + formatDate(data.timestamp);
    author.setAttribute('class', 'author');

    const content = document.createElement('div');
    content.innerText = data.message;
    content.setAttribute('class', 'content');

    message.appendChild(author);
    message.appendChild(content);

    messages.appendChild(message);
    messages.scrollTo(0, document.body.scrollHeight);
  });

  const formatDate = (timestamp) => {
    const date = new Date(timestamp);

    return formatDatePart(date.getDay()) + '/' + formatDatePart(date.getMonth()) + '/' + date.getFullYear() + ' '
      + formatDatePart(date.getHours()) + ':' + formatDatePart(date.getMinutes());
  }

  const formatDatePart = (part) => {
    return (part > 0 && part < 10) ? '0' + part : part;
  }
</script>
</body>
</html>
